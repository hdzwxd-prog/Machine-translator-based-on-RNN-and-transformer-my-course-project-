# 数据预处理缓存功能说明

## 功能概述

数据预处理缓存功能可以避免每次训练都重新执行耗时的数据预处理步骤。如果预处理结果已经存在且配置匹配，系统会自动从缓存加载，显著加快训练启动速度。

## 工作原理

1. **缓存键生成**：基于数据配置参数（数据文件路径、预处理参数、词汇表参数）生成唯一的MD5哈希值作为缓存键
2. **缓存检查**：训练开始时检查是否存在匹配的缓存文件
3. **自动加载**：如果缓存存在且配置匹配，直接加载预处理结果
4. **自动保存**：如果缓存不存在，执行预处理并自动保存到缓存

## 缓存内容

缓存文件包含以下内容：
- 预处理后的训练集数据（train_src, train_tgt）
- 预处理后的验证集数据（valid_src, valid_tgt）
- 构建好的源语言词汇表（src_vocab）
- 构建好的目标语言词汇表（tgt_vocab）

## 配置选项

在配置文件的`training`部分添加：

```yaml
training:
  use_data_cache: true  # 是否使用数据预处理缓存（默认true）
```

- `true`：启用缓存（推荐）
- `false`：禁用缓存，每次都重新预处理

## 缓存目录

缓存文件保存在 `cache/` 目录下，文件命名格式为：`{cache_key}.pkl`

## 缓存键影响因素

以下配置参数的变化会导致缓存失效，需要重新预处理：
- `data.data_dir`：数据目录
- `data.train_file`：训练文件
- `data.valid_file`：验证文件
- `data.source_lang`：源语言
- `data.target_lang`：目标语言
- `data.max_length`：最大句子长度
- `data.min_freq`：最小词频
- `data.max_vocab_size`：最大词汇表大小

## 使用示例

### 启用缓存（默认）
```yaml
training:
  use_data_cache: true
```

### 禁用缓存
```yaml
training:
  use_data_cache: false
```

## 性能提升

使用缓存可以显著加快训练启动速度：
- **首次运行**：正常执行预处理（可能需要几分钟）
- **后续运行**：从缓存加载（通常只需几秒钟）

## 注意事项

1. **磁盘空间**：缓存文件可能较大（取决于数据集大小），请确保有足够的磁盘空间
2. **配置变更**：如果修改了影响预处理的配置参数，缓存会自动失效并重新生成
3. **手动清理**：如需清理缓存，删除 `cache/` 目录即可
4. **向后兼容**：即使禁用缓存，词汇表仍会保存到 `vocabs/` 目录（保持向后兼容）

## 故障排除

### 缓存加载失败
如果缓存加载失败，系统会自动回退到重新预处理，并输出警告信息。

### 清理缓存
如果需要强制重新预处理：
```bash
rm -rf cache/
```

### 检查缓存状态
缓存文件保存在 `cache/` 目录，可以通过查看该目录了解缓存情况。

